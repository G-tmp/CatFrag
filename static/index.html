<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watch catfrag</title>
  <script src="js/tailwind-3.4.17.js"></script>
  <script src="js/artplayer-5.3.0.js"></script>
  <script src="js/hls-1.6.13.js"></script>
</head>
<body class="bg-cover bg-center bg-no-repeat bg-fixed min-h-screen">

  <!-- Search bar -->
  <div class="p-6 flex justify-center">
    <input id="searchInput" type="text" placeholder="Search..."
      class="w-1/2 p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    <button id="searchBtn"
      class="px-4 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600">Search</button>
  </div>

  <!-- Tabs grid -->
  <div id="tabs" class="flex flex-wrap gap-2 pt-6 md:pl-10 pl-4 or-10"></div>

  <!-- Results grid -->
  <div id="results" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 p-4 md:gap-10 md:p-10"></div>

  <!-- Episodes Modal -->
  <div id="episodeModal"
       class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
       onclick="closeEpisodeModal(event)">
    <div class="bg-white rounded-lg shadow-lg w-3/4 max-w-2xl p-4 flex flex-col max-h-[90vh]"
         onclick="event.stopPropagation()">

      <!-- Title -->
      <h2 id="modalTitle" class="text-l font-bold mb-2 text-center">Episodes</h2>

      <!-- Episodes list -->
      <div id="episodes"
           class="grid grid-cols-2 md:grid-cols-5 gap-3 overflow-y-auto flex-1 p-1 md:p-5 rounded">
      </div>
    </div>
  </div>

  <!-- Player Modal -->
  <div id="playerModal"
       class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center"
       onclick="closePlayerModal(event)">
    <div class="bg-black w-full h-3/5 md:w-4/5 md:h-4/5 rounded-lg shadow-lg flex items-center justify-center"
         onclick="event.stopPropagation()">
      <div id="player" class="w-full h-full"></div>
    </div>
  </div>


  <script>
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const tabs = document.getElementById('tabs');
    const resultsDiv = document.getElementById('results');
    const modal = document.getElementById('episodeModal');
    const modalTitle = document.getElementById('modalTitle');
    const episodesDiv = document.getElementById('episodes');
    const playerDiv = document.getElementById('player');
    let art = null;
    let allResults = [];
    let activeTab = null;
    

    window.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch("/config");
      const config = await res.json();
      console.log("Loaded config:", config);
      document.title = config.site_name;
      document.body.style.backgroundImage = `url('${config.background_image_pc}')`;
    });


    searchInput.addEventListener('keyup', function(event) {
      if (event.key === "Enter") {
        searchBtn.click();
      }
    });


    searchBtn.onclick = () => {
      tabs.innerHTML = "";
      resultsDiv.innerHTML = "";
      allResults = [];
      const keyword = searchInput.value.trim();
      if (!keyword) 
        return;

      const evtSource = new EventSource(`/search?keyword=${keyword}`);

      evtSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.result.length == 0) 
          return

        allResults.push(data);
        renderTab(data.name);
        data.result.forEach(async item => {
          item.resolution = await extractM3U8Resolutions(item.vods[0].ep_url);
          renderCard(item, data.name);
        });
      };

      evtSource.onerror = () => {
        evtSource.close();
        console.log(allResults);
      };
    };


    function renderTab(name){
      const btn = document.createElement("button");
      btn.innerText = name;
      btn.className = `
        px-4 py-2 rounded-lg text-xs md:text-sm font-medium transition md:hover:bg-blue-200 bg-gray-100
      `;
      tabs.appendChild(btn);
      btn.onclick = () => {
        if (name === activeTab){
          activeTab = null;
        } else {
          activeTab = name;
        }
        resultsDiv.innerHTML = "";

        if (activeTab) {
          allResults.find(i => i.name === name).result.forEach(i => {
            renderCard(i, name);
          })
          tabs.querySelectorAll("button").forEach(el => {
            el.classList.remove("bg-blue-200");
            el.classList.add("bg-gray-100");
          });
          btn.classList.remove("bg-gray-100");
          btn.classList.add("bg-blue-200");
        } else {
          // render all 
          allResults.forEach(re => {
            re.result?.forEach(i => {
              renderCard(i, re.name);
            });
          });
          tabs.querySelectorAll("button").forEach(el => {
            el.classList.remove("bg-blue-200");
            el.classList.add("bg-gray-100");
          });
        }

      }
    }


    async function renderCard(item, name){
      const card = document.createElement('div');
      card.className = "bg-white rounded-lg shadow-sm hover:shadow-lg transition overflow-hidden cursor-pointer";
      card.innerHTML = `
        <div class="relative">
          <img src="${item.vod_pic}" class="w-full h-40 md:h-60 lg:h-80 object-cover" loading="lazy">
          <div class="absolute top-2 right-2 bg-black/70 text-white text-sm md:text-base px-1 py-0.5 rounded">
            ${item.vods.length} ${item.vods.length > 1 ? "eps" : "ep"}
          </div>
          ${item.resolution
          ? `<div class="absolute bottom-2 left-2 bg-black/70 text-white text-sm md:text-base px-1 py-0.5 rounded">
              ${item.resolution}
            </div>`
          : ``
          }
        </div>
        <div class="p-1 text-center">
          <div class="text-gray-900 font-semibold text-sm lines-2">${item.vod_name}</div>
          <div class="text-xs text-gray-500 mt-1 truncate">${name}</div>
        </div>
      `;

      card.onclick = () => showEpisodes(item);
      resultsDiv.appendChild(card);
    }


    async function extractM3U8Resolutions(url) {
      try {
        const response = await fetch(url);
        const data = await response.text();

        const lines = data.split('\n');
        const resolutions = [];

        for (let line of lines) {
          if (line.startsWith('#EXT-X-STREAM-INF')) {
            const match = line.match(/RESOLUTION=(\d+x\d+)/);
            if (match) {
              resolutions.push(match[1]);
            }
          }
        }

        return resolutions.length > 0 ? resolutions : null;
      } catch (error) {
        return null;
      }
    }


    function showEpisodes(item) {
      modalTitle.innerText = item.vod_name;
      episodesDiv.innerHTML = "";
      episodeModal.classList.remove("hidden");
      episodeModal.classList.add("flex");
      document.body.classList.add('overflow-hidden');

      item.vods.forEach((ep) => {
        const btn = document.createElement('a');
        btn.className = "block p-2 text-sm border rounded bg-gray-100 hover:bg-blue-500 hover:text-white transition text-center ";
        btn.href = ep.ep_url;
        btn.innerText = ep.ep_name;
        btn.onclick = (e) => {
          e.preventDefault();
          // active most recently clicked ep
          episodesDiv.querySelectorAll("a").forEach(el => {
            el.classList.remove("bg-blue-500", "text-white");
            el.classList.add("bg-gray-100");
          });
          btn.classList.remove("bg-gray-100");
          btn.classList.add("bg-blue-500", "text-white");
          btn.scrollIntoView({ behavior: 'smooth', block: 'center' })

          openPlayer(ep.ep_url);
          console.log("now play", ep);
        }

        episodesDiv.appendChild(btn);
      });
    }


    function closeEpisodeModal(event) {
      if (event.target.id === "episodeModal") {
        episodeModal.classList.add("hidden");
        document.body.classList.remove('overflow-hidden');
      }
    }


    function openPlayer(url) {
      playerModal.classList.remove("hidden");
      playerModal.classList.add("flex");

      if (art){
        art.destroy();
        art = null;
      }
      art = new Artplayer({
        container: playerDiv,
        theme: '#0d6efd',
        url: url,
        volume: 1,
        setting: true,
        autoplay: true,
        autoSize: false,
        flip: true,
        playbackRate: true,
        aspectRatio: true,
        fullscreen: true,
        fullscreenWeb: true,
        type: url.endsWith(".m3u8") ? "m3u8" : "normal",
        customType: {
          m3u8: function (video, url) {
            if (Hls.isSupported()) {
              const hls = new Hls();
              hls.loadSource(url);
              hls.attachMedia(video);
              art.hls = hls;
              art.on('destroy', () => hls.destroy());
            } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
              video.src = url; // Safari
            } else {
                art.notice.show = 'Unsupported playback format: m3u8';
            }
          }
        }
      });

      art.isFocus = true;
      document.onkeydown = ev => {
        if (ev.key == "f") {
          if (art)
            art.fullscreen = !art.fullscreen;
        }
      }
    }


    function closePlayerModal(event) {
      if (event.target.id === "playerModal") {
        playerModal.classList.add("hidden");
        if (art) 
          art.destroy();
          art = null;
      }
    }

  </script>
</body>
</html>